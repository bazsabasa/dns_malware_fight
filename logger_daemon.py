#!/usr/bin/python3

import sys
import os
import subprocess
import json
device =''
cmd = "/root/bin/tplink_smartplug.py -t" + device + "-c info "
cmd_on = "/root/bin/tplink_smartplug.py -t" + device + "-c on "



hosts = [ "192.168.0.99" ]
devices = [ "192.168.0.80" ]

def check_host(host):
        response=os.system("ping -c 1 -q "+ host)
        if response == 0:
            os.system("logger -t" + sys.argv[0] + " Itthon van " + host)
            return 1
        elif response != 0:
            os.system("logger Nincs itthon" + host)
            return 0

def get_device_status(device):
        cmd = "/root/bin/tplink_smartplug.py -t" + device + " -c info "
        os.system(cmd)
        with open('state.txt') as a:
            data=json.load(a)
            return (data["system"]["get_sysinfo"]["relay_state"])


for host in hosts:
    if not check_host(host):
        for device in devices:
            print("nincs itthon")
            if get_device_status(device):
                cmd_off = "/root/bin/tplink_smartplug.py -t " + device + " -c off "
                os.system(cmd_off)
            else:
               break 
    elif check_host(host):
        for device in devices:
            if not get_device_status(device):
                cmd_on = "/root/bin/tplink_smartplug.py -t " + device + " -c on "
                os.system(cmd_on)
            else:
               break


